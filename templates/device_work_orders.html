{% extends "layout.html" %}

{% block title %}{{ device.cihaz_adi }} - ƒ∞≈ü Emirleri{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .stats-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        transition: all 0.3s;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .stats-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 1.5rem;
        color: white;
    }

    .stats-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stats-active { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); }
    .stats-completed { background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%); }
    .stats-efficiency { background: linear-gradient(135deg, #e17055 0%, #f39c12 100%); }

    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 30px;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -24px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #007bff;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #007bff;
    }

    .timeline-item.active::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .timeline-item.completed::before {
        background: #17a2b8;
        box-shadow: 0 0 0 2px #17a2b8;
    }

    .work-order-details {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .progress-ring {
        width: 120px;
        height: 120px;
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.35s;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
</style>
{% endblock %}

{% block content %}

<!-- device_work_orders.html sayfasƒ±na eklenecek widget -->

<div class="row mb-4" id="liveProductionWidget" style="display: none;">
  <div class="col-12">
    <div class="card border-success">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          üî¥ CANLI √úRETƒ∞M - <span id="liveWorkOrderNo">-</span>
          <span class="badge bg-light text-success ms-2" id="liveStatus">Aktif</span>
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- √úretim Bilgileri -->
          <div class="col-md-4">
            <h6 class="text-primary">üìä √úretim Durumu</h6>
            <table class="table table-sm">
              <tr>
                <td>√úr√ºn Tipi:</td>
                <td><strong id="liveProductType">-</strong></td>
              </tr>
              <tr>
                <td>Hedef:</td>
                <td><strong id="liveTarget">0</strong> adet</td>
              </tr>
              <tr>
                <td>√úretilen:</td>
                <td><strong class="text-success" id="liveProduced">0</strong> adet</td>
              </tr>
              <tr>
                <td>Fire:</td>
                <td><strong class="text-danger" id="liveFire">0</strong> adet</td>
              </tr>
              <tr>
                <td>Kalan:</td>
                <td><strong id="liveRemaining">0</strong> adet</td>
              </tr>
            </table>
          </div>

          <!-- Performans Metrikleri -->
          <div class="col-md-4">
            <h6 class="text-info">‚ö° Performans</h6>
            <div class="mb-2">
              <small>OEE</small>
              <div class="progress">
                <div class="progress-bar bg-primary" id="oeeBar" style="width: 0%">
                  <span id="oeeValue">0%</span>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <small>Kullanƒ±labilirlik</small>
              <div class="progress">
                <div class="progress-bar bg-info" id="availabilityBar" style="width: 0%">
                  <span id="availabilityValue">0%</span>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <small>Kalite</small>
              <div class="progress">
                <div class="progress-bar bg-success" id="qualityBar" style="width: 0%">
                  <span id="qualityValue">0%</span>
                </div>
              </div>
            </div>
            <div class="mb-2">
              <small>Performans</small>
              <div class="progress">
                <div class="progress-bar bg-warning" id="performanceBar" style="width: 0%">
                  <span id="performanceValue">0%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Zaman ve Hƒ±z -->
          <div class="col-md-4">
            <h6 class="text-warning">‚è±Ô∏è Zaman Analizi</h6>
            <table class="table table-sm">
              <tr>
                <td>Operat√∂r:</td>
                <td><strong id="liveOperator">-</strong></td>
              </tr>
              <tr>
                <td>Ba≈ülama:</td>
                <td><small id="liveStartTime">-</small></td>
              </tr>
              <tr>
                <td>Ge√ßen S√ºre:</td>
                <td><strong id="liveElapsed">0</strong> dk</td>
              </tr>
              <tr>
                <td>√úretim Hƒ±zƒ±:</td>
                <td><strong id="liveRate">0</strong> adet/dk</td>
              </tr>
              <tr>
                <td>Tahmini Biti≈ü:</td>
                <td><strong id="liveEstimation">-</strong> dk</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Tamamlanma √áubuƒüu -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="d-flex justify-content-between">
              <small>ƒ∞lerleme</small>
              <small><span id="completionPercent">0</span>% Tamamlandƒ±</small>
            </div>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                   id="completionBar" style="width: 0%">
                <span id="completionText">0 / 0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Canlƒ± √ºretim verilerini y√ºkle
function loadLiveProduction() {
  const deviceId = '{{ device.cihaz_id }}'; // Flask template'den cihaz ID'si al
  
  fetch(`/api/live_production/${deviceId}`)
    .then(response => response.json())
    .then(data => {
      if (data.active) {
        // Widget'i g√∂ster
        document.getElementById('liveProductionWidget').style.display = 'block';
        
        // ƒ∞≈ü emri bilgileri
        document.getElementById('liveWorkOrderNo').textContent = data.work_order.is_emri_no;
        document.getElementById('liveProductType').textContent = data.work_order.urun_tipi;
        document.getElementById('liveOperator').textContent = data.work_order.operator_ad;
        document.getElementById('liveStartTime').textContent = data.work_order.baslama_zamani;
        
        // √úretim sayƒ±larƒ±
        document.getElementById('liveTarget').textContent = data.work_order.hedef_urun;
        document.getElementById('liveProduced').textContent = data.current_production.gerceklesen_urun;
        document.getElementById('liveFire').textContent = data.current_production.fire_sayisi;
        document.getElementById('liveRemaining').textContent = data.current_production.hedef_kalan;
        
        // Performans metrikleri
        updateProgressBar('oee', data.performance.oee);
        updateProgressBar('availability', data.performance.kullanilabilirlik);
        updateProgressBar('quality', data.performance.kalite);
        updateProgressBar('performance', data.performance.performans);
        
        // Zaman bilgileri
        document.getElementById('liveElapsed').textContent = data.timing.elapsed_minutes;
        document.getElementById('liveRate').textContent = data.timing.production_rate_per_minute;
        document.getElementById('liveEstimation').textContent = 
          data.timing.estimated_completion_minutes > 0 ? data.timing.estimated_completion_minutes : 'Hesaplanƒ±yor';
        
        // Tamamlanma √ßubuƒüu
        const completionPercent = data.current_production.tamamlanma_orani;
        document.getElementById('completionPercent').textContent = completionPercent;
        document.getElementById('completionBar').style.width = completionPercent + '%';
        document.getElementById('completionText').textContent = 
          `${data.current_production.gerceklesen_urun} / ${data.work_order.hedef_urun}`;
        
      } else {
        // Aktif i≈ü emri yok, widget'i gizle
        document.getElementById('liveProductionWidget').style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Canlƒ± √ºretim verisi y√ºklenirken hata:', error);
      document.getElementById('liveProductionWidget').style.display = 'none';
    });
}

// Progress bar g√ºncelleme fonksiyonu
function updateProgressBar(type, value) {
  const bar = document.getElementById(type + 'Bar');
  const text = document.getElementById(type + 'Value');
  
  bar.style.width = value + '%';
  text.textContent = value + '%';
  
  // Renk kodlarƒ± (deƒüere g√∂re)
  if (value >= 80) {
    bar.className = bar.className.replace(/bg-\w+/, 'bg-success');
  } else if (value >= 60) {
    bar.className = bar.className.replace(/bg-\w+/, 'bg-warning');
  } else {
    bar.className = bar.className.replace(/bg-\w+/, 'bg-danger');
  }
}

// Sayfa y√ºklendiƒüinde ba≈ülat
document.addEventListener('DOMContentLoaded', function() {
  loadLiveProduction();
  
  // Her 10 saniyede bir g√ºncelle
  setInterval(loadLiveProduction, 10000);
});
</script>

<style>
.progress {
  font-size: 12px;
  font-weight: bold;
}

.progress-bar span {
  color: white;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

#liveProductionWidget .card-header {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { background-color: #198754; }
  50% { background-color: #157347; }
  100% { background-color: #198754; }
}
</style>


<div class="container-fluid">
    <!-- Sayfa Ba≈ülƒ±ƒüƒ± -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-light me-3" onclick="window.history.back()">
                    <i class="fas fa-arrow-left"></i> Geri
                </button>
                <h2 class="d-inline-block mb-0">{{ device.cihaz_adi }}</h2>
                <span class="badge bg-light text-dark ms-3">{{ device.cihaz_id }}</span>
            </div>
            <div>
                <a href="{{ url_for('cihaz_detay', cihaz_id=device.cihaz_id) }}" class="btn btn-light">
                    <i class="fas fa-chart-line"></i> Cihaz Detayƒ±
                </a>
            </div>
        </div>
        <div class="mt-2">
            <small><i class="fas fa-map-marker-alt"></i> {{ device.konum }}</small>
            {% if device.fabrika_adi %}
            <small class="ms-3"><i class="fas fa-industry"></i> {{ device.fabrika_adi }}</small>
            {% endif %}
        </div>
    </div>

    <!-- ƒ∞statistikler -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon stats-total">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <h3 id="totalOrders">{{ work_orders|length }}</h3>
            <small class="text-muted">Toplam ƒ∞≈ü Emri</small>
        </div>

        <div class="stats-card">
            <div class="stats-icon stats-active">
                <i class="fas fa-play-circle"></i>
            </div>
            <h3 id="activeOrders">{{ work_orders|selectattr('is_emri_durum', 'equalto', 1)|list|length }}</h3>
            <small class="text-muted">Aktif ƒ∞≈ü Emri</small>
        </div>

        <div class="stats-card">
            <div class="stats-icon stats-completed">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 id="completedOrders">{{ work_orders|selectattr('is_emri_durum', 'equalto', 2)|list|length }}</h3>
            <small class="text-muted">Tamamlanan</small>
        </div>

        <div class="stats-card">
            <div class="stats-icon stats-efficiency">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 id="avgEfficiency">
                {% set completed_orders = work_orders|selectattr('is_emri_durum', 'equalto', 2)|selectattr('hedef_urun', 'greaterthan', 0)|list %}
                {% if completed_orders %}
                    {% set total_efficiency = completed_orders|sum(attribute='gerceklesen_urun') * 100 / completed_orders|sum(attribute='hedef_urun') %}
                    {{ "%.1f"|format(total_efficiency) }}%
                {% else %}
                    -%
                {% endif %}
            </h3>
            <small class="text-muted">Ortalama Verimlilik</small>
        </div>
    </div>

    <div class="row">
        <!-- ƒ∞≈ü Emri Listesi -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>ƒ∞≈ü Emri Ge√ßmi≈üi
                    </h5>
                    <div>
                        <select class="form-select form-select-sm" id="statusFilter" onchange="filterOrders()">
                            <option value="">T√ºm Durumlar</option>
                            <option value="0">Bekliyor</option>
                            <option value="1">Aktif</option>
                            <option value="2">Tamamlandƒ±</option>
                            <option value="3">ƒ∞ptal</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    {% if work_orders %}
                    <div class="timeline">
                        {% for wo in work_orders %}
                        <div class="timeline-item {% if wo.is_emri_durum == 1 %}active{% elif wo.is_emri_durum == 2 %}completed{% endif %}"
                             data-status="{{ wo.is_emri_durum }}">
                            <div class="work-order-details">
                                <!-- Ba≈ülƒ±k -->
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="mb-1">{{ wo.is_emri_no }}</h6>
                                        <small class="text-muted">{{ wo.created_at|format_db_datetime if wo.created_at else 'Bilinmiyor' }}</small>
                                    </div>
                                    <div>
                                        {% set status_class = 'secondary' if wo.is_emri_durum == 0 else 'success' if wo.is_emri_durum == 1 else 'primary' if wo.is_emri_durum == 2 else 'danger' %}
                                        {% set status_text = 'Bekliyor' if wo.is_emri_durum == 0 else 'Aktif' if wo.is_emri_durum == 1 else 'Tamamlandƒ±' if wo.is_emri_durum == 2 else 'ƒ∞ptal' %}
                                        <span class="badge bg-{{ status_class }}">{{ status_text }}</span>
                                    </div>
                                </div>

                                <!-- √úr√ºn Bilgileri -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>√úr√ºn:</strong> {{ wo.urun_tipi or 'Belirtilmemi≈ü' }}<br>
                                        <strong>Operat√∂r:</strong> {{ wo.operator_ad or 'Belirtilmemi≈ü' }}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Hedef:</strong> {{ "{:,}".format(wo.hedef_urun) if wo.hedef_urun else '0' }} adet<br>
                                        <strong>Vardiya:</strong> {{ wo.shift_bilgisi or 'Belirtilmemi≈ü' }}
                                    </div>
                                </div>

                                <!-- Zaman Bilgileri -->
                                {% if wo.baslama_zamani or wo.bitis_zamani %}
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-play-circle me-1"></i>
                                            <strong>Ba≈ülama:</strong> {{ wo.baslama_zamani|format_work_order_time if wo.baslama_zamani else 'Ba≈ülamamƒ±≈ü' }}
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-stop-circle me-1"></i>
                                            <strong>Biti≈ü:</strong> {{ wo.bitis_zamani|format_work_order_time if wo.bitis_zamani else 'Devam ediyor' }}
                                        </small>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Performans (Tamamlanmƒ±≈ü i≈ü emirleri i√ßin) -->
                                {% if wo.is_emri_durum == 2 and wo.hedef_urun and wo.hedef_urun > 0 %}
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-0">{{ "{:,}".format(wo.gerceklesen_urun or 0) }}</div>
                                            <small class="text-muted">Ger√ßekle≈üen</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="h5 mb-0">{{ "{:,}".format(wo.fire_sayisi or 0) }}</div>
                                            <small class="text-muted">Fire</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            {% set quality_rate = ((wo.gerceklesen_urun - (wo.fire_sayisi or 0)) * 100 / wo.gerceklesen_urun)|round(1) if wo.gerceklesen_urun else 0 %}
                                            <div class="h5 mb-0" style="color: {% if quality_rate >= 95 %}#28a745{% elif quality_rate >= 90 %}#ffc107{% else %}#dc3545{% endif %}">
                                                {{ quality_rate }}%
                                            </div>
                                            <small class="text-muted">Kalite</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            {% set efficiency = (wo.gerceklesen_urun * 100 / wo.hedef_urun)|round(1) %}
                                            <div class="h5 mb-0" style="color: {% if efficiency >= 100 %}#28a745{% elif efficiency >= 80 %}#ffc107{% else %}#dc3545{% endif %}">
                                                {{ efficiency }}%
                                            </div>
                                            <small class="text-muted">Verimlilik</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Hen√ºz ƒ∞≈ü Emri Yok</h5>
                        <p class="text-muted">Bu cihaz i√ßin hen√ºz i≈ü emri verisi bulunmamaktadƒ±r.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Aktif ƒ∞≈ü Emri Detayƒ± -->
        <div class="col-lg-4">
            {% set active_order = work_orders|selectattr('is_emri_durum', 'equalto', 1)|first %}
            {% if active_order %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-play-circle me-2"></i>Aktif ƒ∞≈ü Emri
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="text-success">{{ active_order.is_emri_no }}</h6>

                    <!-- ƒ∞lerleme √áemberi -->
                    <div class="text-center mb-3 position-relative">
                        {% if active_order.hedef_urun and active_order.hedef_urun > 0 %}
                            {% set progress = (active_order.gerceklesen_urun or 0) * 100 / active_order.hedef_urun %}
                            {% set progress_clamped = [progress, 100]|min %}
                        {% else %}
                            {% set progress_clamped = 0 %}
                        {% endif %}

                        <svg class="progress-ring" width="120" height="120">
                            <circle class="progress-ring-circle"
                                    stroke="#e9ecef"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="52"
                                    cx="60"
                                    cy="60"/>
                            <circle class="progress-ring-circle"
                                    stroke="#28a745"
                                    stroke-width="8"
                                    fill="transparent"
                                    r="52"
                                    cx="60"
                                    cy="60"
                                    stroke-dasharray="{{ 327 }}"
                                    stroke-dashoffset="{{ 327 - (327 * progress_clamped / 100) }}"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <div class="h4 mb-0">{{ "%.0f"|format(progress_clamped) }}%</div>
                            <small class="text-muted">Tamamlandƒ±</small>
                        </div>
                    </div>

                    <!-- Detaylar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Hedef:</span>
                            <strong>{{ "{:,}".format(active_order.hedef_urun or 0) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Ger√ßekle≈üen:</span>
                            <strong class="text-success">{{ "{:,}".format(active_order.gerceklesen_urun or 0) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Kalan:</span>
                            <strong class="text-warning">
                                {{ "{:,}".format((active_order.hedef_urun or 0) - (active_order.gerceklesen_urun or 0)) }}
                            </strong>
                        </div>
                    </div>

                    <!-- √úr√ºn ve Operat√∂r -->
                    <div class="mb-3">
                        <small class="text-muted d-block">√úr√ºn Tipi:</small>
                        <strong>{{ active_order.urun_tipi or 'Belirtilmemi≈ü' }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Operat√∂r:</small>
                        <strong>{{ active_order.operator_ad or 'Belirtilmemi≈ü' }}</strong>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block">Vardiya:</small>
                        <strong>{{ active_order.shift_bilgisi or 'Belirtilmemi≈ü' }}</strong>
                    </div>

                    <!-- Zaman Bilgisi -->
                    {% if active_order.baslama_zamani %}
                    <div class="mb-3">
                        <small class="text-muted d-block">Ba≈ülama Zamanƒ±:</small>
                        <strong>{{ active_order.baslama_zamani|format_work_order_time }}</strong>
                    </div>
                    {% endif %}

                    <!-- Aksiyonlar -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshActiveOrder()">
                            <i class="fas fa-sync-alt"></i> Yenile
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showOrderDetails({{ active_order.id }})">
                            <i class="fas fa-info-circle"></i> Detaylar
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Hƒ±zlƒ± ƒ∞statistikler -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>√ñzet ƒ∞statistikler
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Bu Ay Tamamlanan - D√úZELTƒ∞LMƒ∞≈û -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Bu Ay Tamamlanan:</span>
                            <span class="badge bg-primary">
                                {% set completed_this_month = 0 %}
                                {% for order in work_orders %}
                                    {% if order.is_emri_durum == 2 and order.created_at and '2025-06' in order.created_at %}
                                        {% set completed_this_month = completed_this_month + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ completed_this_month }}
                            </span>
                        </div>
                    </div>

                    <!-- Son 7 G√ºn - D√úZELTƒ∞LMƒ∞≈û -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Son 7 G√ºn:</span>
                            <span class="badge bg-info">
                                {% set recent_orders = 0 %}
                                {% for order in work_orders %}
                                    {% if order.created_at and order.created_at >= '2025-05-28' %}
                                        {% set recent_orders = recent_orders + 1 %}
                                    {% endif %}
                                {% endfor %}
                                {{ recent_orders }}
                            </span>
                        </div>
                    </div>

                    <!-- Ortalama S√ºre -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Ort. Tamamlama:</span>
                            <span class="text-muted">~2.5 g√ºn</span>
                        </div>
                    </div>

                    <!-- En Y√ºksek Verimlilik - BASƒ∞TLE≈ûTƒ∞Rƒ∞LMƒ∞≈û -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>En Y√ºksek Verim:</span>
                            <span class="text-success">
                                {% set best_efficiency = 0 %}
                                {% for order in work_orders %}
                                    {% if order.is_emri_durum == 2 and order.hedef_urun and order.hedef_urun > 0 and order.gerceklesen_urun %}
                                        {% set efficiency = (order.gerceklesen_urun * 100 / order.hedef_urun) %}
                                        {% if efficiency > best_efficiency %}
                                            {% set best_efficiency = efficiency %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {{ "%.1f"|format(best_efficiency) }}%
                            </span>
                        </div>
                    </div>

                    <!-- Hƒ±zlƒ± Aksiyonlar -->
                    <hr>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportWorkOrders()">
                            <i class="fas fa-download"></i> Excel ƒ∞ndir
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showPerformanceChart()">
                            <i class="fas fa-chart-line"></i> Performans Grafiƒüi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Durum filtresi
function filterOrders() {
    const statusFilter = document.getElementById('statusFilter').value;
    const items = document.querySelectorAll('.timeline-item');

    items.forEach(item => {
        const status = item.dataset.status;
        const show = !statusFilter || status === statusFilter;
        item.style.display = show ? 'block' : 'none';
    });
}

// Aktif i≈ü emrini yenile
function refreshActiveOrder() {
    fetch(`/api/work_order_summary/{{ device.cihaz_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.active_work_order) {
                // Sayfayƒ± yenile veya verilerini g√ºncelle
                location.reload();
            } else {
                alert('Aktif i≈ü emri bulunamadƒ±');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Veri g√ºncellenirken hata olu≈ütu');
        });
}

// ƒ∞≈ü emri detaylarƒ±nƒ± g√∂ster
function showOrderDetails(orderId) {
    // Modal veya yeni sayfa a√ßma
    alert(`ƒ∞≈ü emri detaylarƒ±: ${orderId}`);
}

// Excel export
function exportWorkOrders() {
    const url = `/api/work_orders/{{ device.cihaz_id }}/export`;
    window.open(url, '_blank');
}

// Performans grafiƒüi
function showPerformanceChart() {
    // Chart.js ile performans grafiƒüi g√∂sterme
    alert('Performans grafiƒüi √∂zelliƒüi yakƒ±nda eklenecek');
}

// Otomatik yenileme (aktif i≈ü emri varsa)
{% if work_orders|selectattr('is_emri_durum', 'equalto', 1)|list %}
setInterval(() => {
    // Sadece aktif i≈ü emri verilerini yenile
    refreshActiveOrder();
}, 60000); // 1 dakikada bir
{% endif %}
</script>
{% endblock %}
