{% extends "layout.html" %}

{% block title %}Kullanıcı Yönetimi{% endblock %}

{% block extra_css %}
<style>
    .user-card {
        transition: all 0.3s;
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
        margin: 0 auto 15px;
    }
    .user-avatar.admin {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .user-avatar.user {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .user-avatar.viewer {
        background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    }
    .user-avatar.inactive {
        background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
    }
    .role-badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 600;
    }
    .role-admin {
        background: #667eea;
        color: white;
    }
    .role-user {
        background: #11998e;
        color: white;
    }
    .role-viewer {
        background: #74b9ff;
        color: white;
    }
    .status-active {
        color: #27ae60;
    }
    .status-inactive {
        color: #e74c3c;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .stats-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border: none;
        transition: all 0.3s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .stats-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 1.5rem;
        color: white;
    }
    .stats-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stats-admin { background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%); }
    .stats-active { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stats-recent { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
    
    .activity-item {
        border-left: 3px solid #007bff;
        padding-left: 15px;
        margin-bottom: 15px;
        position: relative;
    }
    .activity-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 8px;
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: #007bff;
    }
    .activity-time {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .user-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }
    
    @media (max-width: 768px) {
        .user-grid {
            grid-template-columns: 1fr;
        }
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block breadcrumb %}
<i class="fas fa-users"></i>
<span class="mx-2">/</span>
<a href="{{ url_for('index') }}" class="text-decoration-none">Dashboard</a>
<span class="mx-2">/</span>
Kullanıcı Yönetimi
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Sayfa Başlığı -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-users me-2"></i>Kullanıcı Yönetimi
        </h1>
        <div>
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus"></i> Yeni Kullanıcı
            </button>
            <span class="badge bg-warning">Admin Paneli</span>
        </div>
    </div>

    <!-- İstatistik Kartları -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon stats-total">
                <i class="fas fa-users"></i>
            </div>
            <h3 id="totalUsers">0</h3>
            <small class="text-muted">Toplam Kullanıcı</small>
        </div>
        <div class="stats-card">
            <div class="stats-icon stats-admin">
                <i class="fas fa-crown"></i>
            </div>
            <h3 id="adminUsers">0</h3>
            <small class="text-muted">Yönetici</small>
        </div>
        <div class="stats-card">
            <div class="stats-icon stats-active">
                <i class="fas fa-user-check"></i>
            </div>
            <h3 id="activeUsers">0</h3>
            <small class="text-muted">Aktif Kullanıcı</small>
        </div>
        <div class="stats-card">
            <div class="stats-icon stats-recent">
                <i class="fas fa-clock"></i>
            </div>
            <h3 id="recentLogins">0</h3>
            <small class="text-muted">Son 24h Giriş</small>
        </div>
    </div>

    <!-- Filtre ve Arama -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <select class="form-select" id="roleFilter">
                        <option value="">Tüm Roller</option>
                        <option value="admin">Yönetici</option>
                        <option value="user">Kullanıcı</option>
                        <option value="viewer">Görüntüleyici</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">Tüm Durumlar</option>
                        <option value="active">Aktif</option>
                        <option value="inactive">Pasif</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchInput" placeholder="Kullanıcı ara...">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-eraser"></i> Temizle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Kullanıcı Listesi -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Kullanıcılar</h5>
                    <span class="badge bg-primary" id="userCount">0 kullanıcı</span>
                </div>
                <div class="card-body">
                    <div class="user-grid" id="userGrid">
                        <!-- Kullanıcılar buraya yüklenecek -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Aktivite Logları -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Son Aktiviteler
                    </h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    <div id="activityLog">
                        <!-- Aktiviteler buraya yüklenecek -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Kullanıcı Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Yeni Kullanıcı Ekle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Ad Soyad</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Şifre</label>
                            <input type="password" class="form-control" name="password" required minlength="6">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol</label>
                            <select class="form-select" name="role" required>
                                <option value="user">Kullanıcı</option>
                                <option value="admin">Yönetici</option>
                                <option value="viewer">Görüntüleyici</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Email (İsteğe bağlı)</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" checked>
                                <label class="form-check-label">Aktif kullanıcı</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Kullanıcı Düzenleme Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Kullanıcı Düzenle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <input type="hidden" name="user_id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Ad Soyad</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Yeni Şifre (İsteğe bağlı)</label>
                            <input type="password" class="form-control" name="password" minlength="6">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Rol</label>
                            <select class="form-select" name="role" required>
                                <option value="user">Kullanıcı</option>
                                <option value="admin">Yönetici</option>
                                <option value="viewer">Görüntüleyici</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active">
                                <label class="form-check-label">Aktif kullanıcı</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

// user_management.html içindeki JavaScript bölümünü tamamen bu kodla değiştirin:

<script>
let users = [];
let activities = [];

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadActivities();
    loadStats();
    setupEventListeners();
});

// Event listener'ları ayarla
function setupEventListeners() {
    // Filtre ve arama
    document.getElementById('roleFilter').addEventListener('change', filterUsers);
    document.getElementById('statusFilter').addEventListener('change', filterUsers);
    document.getElementById('searchInput').addEventListener('input', filterUsers);

    // Form submit'leri
    document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
    document.getElementById('editUserForm').addEventListener('submit', handleEditUser);
}

// Kullanıcıları yükle - API ENDPOINT DEĞİŞTİRİLDİ
function loadUsers() {
    // Loading göster
    const container = document.getElementById('userGrid');
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2">Kullanıcılar yükleniyor...</p>
        </div>
    `;

    // ✅ API ENDPOINT DEĞİŞTİRİLDİ: /admin/users → /admin/api/users
    fetch('/admin/api/users')
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response URL:', response.url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            // Content-Type kontrolü
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error(`Expected JSON but got ${contentType}`);
            }

            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);

            if (data.success) {
                users = data.users || [];
                renderUsers();
                updateStats();
                console.log(`✅ ${users.length} kullanıcı yüklendi`);
            } else {
                const errorMsg = data.error || 'Kullanıcılar yüklenemedi';
                showDetailedError('API Hatası', errorMsg);
            }
        })
        .catch(error => {
            console.error('API Error:', error);

            let errorMessage = 'Kullanıcı API\'sine erişilemiyor';
            let errorDetails = error.message;

            if (error.message.includes('Expected JSON but got')) {
                errorMessage = 'Sunucu JSON yerine HTML döndürüyor';
                errorDetails = 'Muhtemelen login gerekli veya endpoint bulunamadı.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'API endpoint bulunamadı';
                errorDetails = '/admin/api/users endpoint\'i henüz oluşturulmamış.';
            } else if (error.message.includes('HTTP 401')) {
                errorMessage = 'Yetkilendirme hatası';
                errorDetails = 'Giriş yapmış olmanıza rağmen API erişim reddedildi.';
            }

            showDetailedError(errorMessage, errorDetails);
        });
}

// Detaylı hata gösterme - GELİŞTİRİLMİŞ
function showDetailedError(title, details) {
    const container = document.getElementById('userGrid');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle"></i> ${title}</h5>
                <p><strong>Detay:</strong> ${details}</p>

                <div class="mt-3">
                    <h6>🔧 Hızlı Çözüm Denemeleri:</h6>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadUsers()">
                            <i class="fas fa-sync-alt"></i> Tekrar Dene
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="testDirectAPI()">
                            <i class="fas fa-flask"></i> API Test
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="createFallbackUsers()">
                            <i class="fas fa-user-plus"></i> Geçici Kullanıcı
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> Sayfayı Yenile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Stats'ları sıfırla
    document.getElementById('totalUsers').textContent = '?';
    document.getElementById('adminUsers').textContent = '?';
    document.getElementById('activeUsers').textContent = '?';
    document.getElementById('recentLogins').textContent = '?';
    document.getElementById('userCount').textContent = 'API Hatası!';
}

// Yeni fonksiyon: API Test
function testDirectAPI() {
    const testResults = document.createElement('div');
    testResults.className = 'mt-3 alert alert-info';
    testResults.innerHTML = '<h6>🧪 API Test Sonuçları:</h6><div id="testOutput">Test ediliyor...</div>';

    document.querySelector('.alert-danger').appendChild(testResults);

    const testOutput = document.getElementById('testOutput');

    // Test 1: Current endpoint
    Promise.all([
        fetch('/admin/api/users').then(r => ({url: '/admin/api/users', status: r.status, ok: r.ok})).catch(e => ({url: '/admin/api/users', error: e.message})),
        fetch('/admin/users').then(r => ({url: '/admin/users', status: r.status, ok: r.ok, type: r.headers.get('content-type')})).catch(e => ({url: '/admin/users', error: e.message}))
    ]).then(results => {
        let output = '<ul>';
        results.forEach(result => {
            if (result.error) {
                output += `<li><code>${result.url}</code>: ❌ ${result.error}</li>`;
            } else {
                output += `<li><code>${result.url}</code>: ${result.ok ? '✅' : '❌'} Status ${result.status} ${result.type ? `(${result.type})` : ''}</li>`;
            }
        });
        output += '</ul>';

        testOutput.innerHTML = output;
    });
}

// Geçici kullanıcı oluştur
function createFallbackUsers() {
    users = [
        {
            id: 1,
            username: 'admin',
            name: 'System Administrator',
            role: 'admin',
            is_active: true,
            created_at: new Date().toISOString(),
            last_login: new Date().toISOString()
        }
    ];

    renderUsers();
    updateStats();

    showNotification('info', 'Geçici admin kullanıcısı oluşturuldu. API düzeltildikten sonra gerçek veriler yüklenecek.');
}

// İstatistikleri yükle - API ENDPOINT DEĞİŞTİRİLDİ
function loadStats() {
    fetch('/admin/api/users/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalUsers').textContent = data.stats.total;
                document.getElementById('adminUsers').textContent = data.stats.admins;
                document.getElementById('activeUsers').textContent = data.stats.active;
                document.getElementById('recentLogins').textContent = data.stats.recent_logins;
            }
        })
        .catch(error => {
            console.error('Stats error:', error);
            // Fallback stats
            updateStats();
        });
}

// Aktivite logları - API ENDPOINT DEĞİŞTİRİLDİ
function loadActivities() {
    fetch('/admin/api/activities')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                activities = data.activities;
                renderActivities();
            }
        })
        .catch(error => {
            console.error('Activities error:', error);
            document.getElementById('activityLog').innerHTML = '<p class="text-muted">Aktivite verileri yüklenemedi</p>';
        });
}

// Kullanıcı ekleme - API ENDPOINT DEĞİŞTİRİLDİ
function handleAddUser(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const userData = {
        name: formData.get('name'),
        username: formData.get('username'),
        password: formData.get('password'),
        role: formData.get('role'),
        email: formData.get('email'),
        is_active: formData.get('is_active') === 'on'
    };

    fetch('/admin/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Kullanıcı başarıyla eklendi');
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            e.target.reset();
            loadUsers();
        } else {
            showNotification('error', data.error || 'Kullanıcı eklenemedi');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'Kullanıcı eklenirken hata oluştu');
    });
}

// Diğer fonksiyonlarda da API endpoint'lerini güncelleyin...
function handleEditUser(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const userId = formData.get('user_id');
    const userData = {
        name: formData.get('name'),
        username: formData.get('username'),
        role: formData.get('role'),
        email: formData.get('email'),
        is_active: formData.get('is_active') === 'on'
    };

    if (formData.get('password')) {
        userData.password = formData.get('password');
    }

    fetch(`/admin/api/users/${userId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Kullanıcı başarıyla güncellendi');
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            loadUsers();
        } else {
            showNotification('error', data.error || 'Kullanıcı güncellenemedi');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('error', 'Kullanıcı güncellenirken hata oluştu');
    });
}

// Geri kalan fonksiyonlar aynı kalacak...
// (renderUsers, filterUsers, toggleUser, deleteUser, vs.)

// AYNI KALAN FONKSİYONLAR (kısalık için tekrar yazmıyorum):
function renderUsers(filteredUsers = null) {
    const userList = filteredUsers || users;
    const container = document.getElementById('userGrid');

    if (userList.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Kullanıcı bulunamadı</h5>
                <p class="text-muted">Henüz kullanıcı verisi yok veya filtrelerinize uygun kullanıcı bulunamadı</p>
            </div>
        `;
        return;
    }

    container.innerHTML = userList.map(user => `
        <div class="user-card card">
            <div class="card-body text-center">
                <div class="user-avatar ${user.role} ${user.is_active ? '' : 'inactive'}">
                    ${user.name ? user.name.charAt(0).toUpperCase() : 'U'}
                </div>
                <h6 class="card-title">${user.name || 'Unnamed User'}</h6>
                <p class="text-muted mb-2">@${user.username}</p>
                <div class="mb-2">
                    <span class="role-badge role-${user.role}">
                        ${getRoleText(user.role)}
                    </span>
                </div>
                <div class="mb-3">
                    <small class="status-${user.is_active ? 'active' : 'inactive'}">
                        <i class="fas fa-circle fa-xs"></i>
                        ${user.is_active ? 'Aktif' : 'Pasif'}
                    </small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">
                        <i class="fas fa-calendar"></i>
                        ${formatDate(user.created_at)}
                    </small>
                </div>
                ${user.last_login ? `
                    <div class="mb-3">
                        <small class="text-success">
                            <i class="fas fa-sign-in-alt"></i>
                            Son giriş: ${formatDate(user.last_login)}
                        </small>
                    </div>
                ` : ''}
                <div class="btn-group w-100">
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-${user.is_active ? 'warning' : 'success'}"
                            onclick="toggleUser(${user.id})">
                        <i class="fas fa-${user.is_active ? 'pause' : 'play'}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewUserActivity(${user.id})">
                        <i class="fas fa-history"></i>
                    </button>
                    ${user.role !== 'admin' || user.id !== getCurrentUserId() ? `
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('userCount').textContent = `${userList.length} kullanıcı`;
}

// Yardımcı fonksiyonlar - AYNI
function updateStats() {
    const total = users.length;
    const admins = users.filter(u => u.role === 'admin').length;
    const active = users.filter(u => u.is_active).length;
    const recent = users.filter(u => {
        if (!u.last_login) return false;
        const loginDate = new Date(u.last_login);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        return loginDate >= yesterday;
    }).length;

    document.getElementById('totalUsers').textContent = total;
    document.getElementById('adminUsers').textContent = admins;
    document.getElementById('activeUsers').textContent = active;
    document.getElementById('recentLogins').textContent = recent;
}

function filterUsers() {
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    let filtered = users.filter(user => {
        const roleMatch = !roleFilter || user.role === roleFilter;
        const statusMatch = !statusFilter ||
            (statusFilter === 'active' && user.is_active) ||
            (statusFilter === 'inactive' && !user.is_active);
        const searchMatch = !searchTerm ||
            (user.name && user.name.toLowerCase().includes(searchTerm)) ||
            user.username.toLowerCase().includes(searchTerm);

        return roleMatch && statusMatch && searchMatch;
    });

    renderUsers(filtered);
}

function clearFilters() {
    document.getElementById('roleFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('searchInput').value = '';
    renderUsers();
}

function getRoleText(role) {
    const roles = {
        'admin': 'Yönetici',
        'user': 'Kullanıcı',
        'viewer': 'Görüntüleyici'
    };
    return roles[role] || role;
}

function formatDate(dateString) {
    if (!dateString) return 'Bilinmiyor';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('tr-TR');
    } catch {
        return 'Geçersiz Tarih';
    }
}

function getCurrentUserId() {
    return 1; // Backend'den alınmalı
}

function showNotification(type, message) {
    // Mevcut bildirimleri temizle
    const existingAlerts = document.querySelectorAll('.alert.auto-dismiss');
    existingAlerts.forEach(alert => alert.remove());

    const alertClass = type === 'success' ? 'alert-success' :
                     type === 'error' ? 'alert-danger' :
                     type === 'info' ? 'alert-info' : 'alert-warning';

    const alertHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show auto-dismiss"
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 500px;">
            <i class="fas fa-${type === 'success' ? 'check-circle' :
                              type === 'error' ? 'exclamation-circle' :
                              type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
            <strong>${type === 'error' ? 'Hata!' : type === 'success' ? 'Başarılı!' : 'Bilgi:'}</strong><br>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('afterbegin', alertHTML);

    setTimeout(() => {
        const alert = document.querySelector('.alert.auto-dismiss');
        if (alert) alert.remove();
    }, 8000);
}

// Placeholder fonksiyonlar (tam implementasyon için)

// ✅ KULLANICI DÜZENLEMe FONKSİYONLARI - AKTİF
function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) {
        showNotification('error', 'Kullanıcı bulunamadı');
        return;
    }

    // Modal formunu doldur
    const form = document.getElementById('editUserForm');
    form.querySelector('input[name="user_id"]').value = user.id;
    form.querySelector('input[name="name"]').value = user.name || '';
    form.querySelector('input[name="username"]').value = user.username;
    form.querySelector('input[name="email"]').value = user.email || '';
    form.querySelector('select[name="role"]').value = user.role;
    form.querySelector('input[name="is_active"]').checked = user.is_active;

    // Şifre alanını temizle
    form.querySelector('input[name="password"]').value = '';

    // Modal'ı aç
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

function toggleUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) {
        showNotification('error', 'Kullanıcı bulunamadı');
        return;
    }

    const newStatus = !user.is_active;
    const action = newStatus ? 'aktif' : 'pasif';
    
    // ✅ DOĞRU URL'LER
    const endpoint = newStatus ? 
        `/admin/api/users/${userId}/activate` : 
        `/admin/api/users/${userId}/deactivate`;

    if (confirm(`${user.name || user.username} kullanıcısını ${action} yapmak istediğinizden emin misiniz?`)) {
        fetch(endpoint, {
            method: 'POST',  // ✅ POST metodu
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', data.message);
                loadUsers(); // Listeyi yenile
            } else {
                showNotification('error', data.error || 'Durum güncellenemedi');
            }
        })
        .catch(error => {
            console.error('Toggle error:', error);
            showNotification('error', 'Durum güncellenirken hata oluştu');
        });
    }
}

function deleteUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) {
        showNotification('error', 'Kullanıcı bulunamadı');
        return;
    }

    // Admin kendini silemez
    if (user.username === 'admin' && user.id === getCurrentUserId()) {
        showNotification('warning', 'Kendi admin hesabınızı silemezsiniz');
        return;
    }

    // Son admin'i silmeyi engelle
    const adminCount = users.filter(u => u.role === 'admin' && u.is_active).length;
    if (user.role === 'admin' && adminCount <= 1) {
        showNotification('warning', 'Son admin kullanıcısını silemezsiniz');
        return;
    }

    const userName = user.name || user.username;
    if (confirm(`⚠️ ${userName} kullanıcısını kalıcı olarak silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
        fetch(`/admin/api/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', 'Kullanıcı başarıyla silindi');
                loadUsers(); // Listeyi yenile
                logActivity('user_delete', `${user.username} kullanıcısı silindi`);
            } else {
                showNotification('error', data.error || 'Kullanıcı silinemedi');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showNotification('error', 'Kullanıcı silinirken hata oluştu');
        });
    }
}

function viewUserActivity(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) {
        showNotification('error', 'Kullanıcı bulunamadı');
        return;
    }

    // Aktivite sayfasına yönlendir veya modal aç
    showNotification('info', `${user.name || user.username} kullanıcısının aktivite geçmişi yükleniyor...`);

    // TODO: Aktivite modal'ı veya sayfası implementasyonu
    setTimeout(() => {
        showNotification('warning', 'Aktivite geçmişi özelliği yakında eklenecek');
    }, 1000);
}
function renderActivities() { document.getElementById('activityLog').innerHTML = '<p class="text-muted">Aktiviteler yükleniyor...</p>'; }
function logActivity(type, desc) { console.log('Activity:', type, desc); }

</script>

{% endblock %}
