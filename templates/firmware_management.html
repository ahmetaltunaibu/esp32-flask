{% extends "layout.html" %}

{% block title %}Firmware Y√∂netimi{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Firmware Y√∂netimi</h1>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Firmware Upload Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Yeni Firmware Y√ºkle</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('upload_firmware') }}" enctype="multipart/form-data" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Firmware Dosyasƒ± (.bin)</label>
                <input type="file" class="form-control" name="file" accept=".bin" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Versiyon Numarasƒ±</label>
                <input type="text" class="form-control" name="version" placeholder="1.1.0" required>
            </div>
            <div class="col-md-5">
                <label class="form-label">S√ºr√ºm Notlarƒ±</label>
                <textarea class="form-control" name="release_notes" rows="1" required></textarea>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Y√ºkle
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Firmware Versions Table -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Firmware Versiyonlarƒ±</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="firmwareTable">
                <thead>
                    <tr>
                        <th>Versiyon</th>
                        <th>Y√ºkleme Tarihi</th>
                        <th>Dosya Boyutu</th>
                        <th>Durum</th>
                        <th>ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for version in versions %}
                    <tr>
                        <td>v{{ version.version }}</td>
                        <td>{{ version.created_at }}</td>
                        <td>
                            {% if version.file_size %}
                                {{ "%0.2f"|format(version.file_size/1024) }} KB
                            {% else %}
                                Bilinmiyor
                            {% endif %}
                        </td>
                        <td>
                            {% if version.is_active %}
                            <span class="badge bg-success">Aktif</span>
                            {% else %}
                            <span class="badge bg-secondary">Pasif</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('download_firmware', version=version.version) }}?api_key=GUVENLI_ANAHTAR_123" 
                               class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-download"></i> ƒ∞ndir
                            </a>
                            {% if not version.is_active %}
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="activateVersion('{{ version.version }}')">
                                <i class="fas fa-check"></i> Aktif Et
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assign Firmware Section -->
<div class="card">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">üéØ Cihazlara Firmware Atamasƒ±</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>√ñnemli:</strong> Firmware atandƒ±ktan sonra cihaz bir sonraki g√ºncelleme kontrol√ºnde yeni firmware'i indirecektir.
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label"><strong>üñ•Ô∏è Cihaz Se√ßin</strong></label>
                <select id="deviceSelect" class="form-select">
                    <option value="">-- Cihaz Se√ßin --</option>
                    {% for cihaz in cihazlar %}
                    <option value="{{ cihaz.cihaz_id }}" 
                            data-current="{{ cihaz.firmware_version }}"
                            data-target="{{ cihaz.target_firmware or 'Yok' }}">
                        {{ cihaz.cihaz_adi }} - Mevcut: v{{ cihaz.firmware_version }}
                        {% if cihaz.target_firmware %}
                         ‚Üí Hedef: v{{ cihaz.target_firmware }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label"><strong>üíæ Atanacak Firmware</strong></label>
                <select id="firmwareSelect" class="form-select">
                    <option value="">-- Versiyon Se√ßin --</option>
                    {% for firmware in versions %}
                    <option value="{{ firmware.version }}" 
                            data-active="{{ firmware.is_active }}"
                            data-notes="{{ firmware.release_notes }}">
                        v{{ firmware.version }}
                        {% if firmware.is_active %}
                        <span class="badge bg-success">Aktif</span>
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Se√ßim Detaylarƒ± -->
        <div id="selectionDetails" class="row mb-3" style="display: none;">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">üì± Se√ßilen Cihaz</h6>
                    </div>
                    <div class="card-body" id="deviceDetails"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">üíæ Se√ßilen Firmware</h6>
                    </div>
                    <div class="card-body" id="firmwareDetails"></div>
                </div>
            </div>
        </div>
        
        <button id="assignFirmwareBtn" class="btn btn-warning btn-lg" disabled>
            <i class="fas fa-paper-plane"></i> Firmware Ata
        </button>
        
        <div id="assignResult" class="mt-3"></div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#firmwareTable').DataTable({
        "order": [[1, "desc"]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json"
        }
    });

    // Function to update button state and show details
    function updateUI() {
        const deviceSelected = $('#deviceSelect').val() !== '';
        const firmwareSelected = $('#firmwareSelect').val() !== '';
        
        $('#assignFirmwareBtn').prop('disabled', !(deviceSelected && firmwareSelected));
        
        if (deviceSelected && firmwareSelected) {
            showSelectionDetails();
        } else {
            $('#selectionDetails').hide();
        }
    }

    function showSelectionDetails() {
        const deviceOption = $('#deviceSelect option:selected');
        const firmwareOption = $('#firmwareSelect option:selected');
        
        // Device details
        const deviceDetails = `
            <strong>Cihaz ID:</strong> ${deviceOption.val()}<br>
            <strong>Mevcut Firmware:</strong> v${deviceOption.data('current')}<br>
            <strong>Hedef Firmware:</strong> ${deviceOption.data('target')}
        `;
        $('#deviceDetails').html(deviceDetails);
        
        // Firmware details
        const firmwareDetails = `
            <strong>Versiyon:</strong> v${firmwareOption.val()}<br>
            <strong>Durum:</strong> ${firmwareOption.data('active') ? '<span class="badge bg-success">Aktif</span>' : '<span class="badge bg-secondary">Pasif</span>'}<br>
            <strong>Notlar:</strong> ${firmwareOption.data('notes') || 'Belirtilmemi≈ü'}
        `;
        $('#firmwareDetails').html(firmwareDetails);
        
        $('#selectionDetails').show();
    }

    // Event listeners
    $('#deviceSelect, #firmwareSelect').on('change', updateUI);

    // Assign firmware button click handler
    $('#assignFirmwareBtn').click(function() {
        const deviceId = $('#deviceSelect').val();
        const firmwareVersion = $('#firmwareSelect').val();
        const deviceName = $('#deviceSelect option:selected').text();

        if (!deviceId || !firmwareVersion) return;

        // Show loading
        $('#assignResult').html(`
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i> <strong>ƒ∞≈ülem yapƒ±lƒ±yor...</strong><br>
                <small>${deviceName} cihazƒ±na v${firmwareVersion} firmware'i atanƒ±yor...</small>
            </div>
        `);

        // Disable button
        $('#assignFirmwareBtn').prop('disabled', true);

        // Send request
        fetch('/assign_firmware', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: deviceId,
                version: firmwareVersion
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Response:', data);  // Debug
            
            if (data.error) {
                $('#assignResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Hata!</strong><br>
                        ${data.error}
                        ${data.details ? '<br><small>' + data.details + '</small>' : ''}
                    </div>
                `);
            } else if (data.success) {
                $('#assignResult').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Ba≈üarƒ±lƒ±!</strong><br>
                        ${data.message}<br>
                        <small class="text-muted">
                            Cihaz: ${data.device} | 
                            Mevcut: v${data.current_version} ‚Üí Hedef: v${data.version}
                        </small>
                        <hr>
                        <button class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> Sayfayƒ± Yenile
                        </button>
                    </div>
                `);
                
                // Update device select option
                const option = $(`#deviceSelect option[value="${deviceId}"]`);
                option.data('target', firmwareVersion);
                option.text(option.text().replace(/‚Üí Hedef:.*/, '') + ` ‚Üí Hedef: v${firmwareVersion}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            $('#assignResult').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> 
                    <strong>ƒ∞leti≈üim Hatasƒ±!</strong><br>
                    Sunucuyla ileti≈üim kurulamadƒ±.
                </div>
            `);
        })
        .finally(() => {
            // Re-enable button
            $('#assignFirmwareBtn').prop('disabled', false);
        });
    });
});

function activateVersion(version) {
    if (confirm(`v${version} firmware'ini aktif etmek istediƒüinize emin misiniz?`)) {
        fetch('/firmware/activate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ version: version })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Bir hata olu≈ütu');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ƒ∞≈ülem ba≈üarƒ±sƒ±z oldu');
        });
    }
}
</script>
{% endblock %}
