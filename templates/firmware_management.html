{% extends "layout.html" %}

{% block title %}Firmware Yönetimi{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Firmware Yönetimi</h1>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Firmware Upload Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Yeni Firmware Yükle</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('upload_firmware') }}" enctype="multipart/form-data" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Firmware Dosyası (.bin)</label>
                <input type="file" class="form-control" name="file" accept=".bin" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Versiyon Numarası</label>
                <input type="text" class="form-control" name="version" placeholder="1.1.0" required>
            </div>
            <div class="col-md-5">
                <label class="form-label">Sürüm Notları</label>
                <textarea class="form-control" name="release_notes" rows="1" required></textarea>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Yükle
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Firmware Versions Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Firmware Versiyonları</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped" id="firmwareTable">
                <thead>
                    <tr>
                        <th>Versiyon</th>
                        <th>Yükleme Tarihi</th>
                        <th>Dosya Boyutu</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for version in versions %}
                    <tr>
                        <td>v{{ version.version }}</td>
                        <td>{{ version.created_at }}</td>
                        <td>
                            {% if version.file_path %}
                                {{ "%0.2f"|format(version.file_size/1024 if version.file_size else 0) }} KB
                            {% else %}
                                Bilinmiyor
                            {% endif %}
                        </td>
                        <td>
                            {% if version.is_active %}
                            <span class="badge bg-success">Aktif</span>
                            {% else %}
                            <span class="badge bg-secondary">Pasif</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('download_firmware', version=version.version) }}" 
                               class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-download"></i> İndir
                            </a>
                            {% if not version.is_active %}
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="activateVersion('{{ version.version }}')">
                                <i class="fas fa-check"></i> Aktif Et
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Assign Firmware Section -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Cihazlara Firmware Ata</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">Cihaz Seçin</label>
                <select id="deviceSelect" class="form-select">
                    <option value="">-- Cihaz Seçin --</option>
                    {% for cihaz in cihazlar %}
                    <option value="{{ cihaz.cihaz_id }}">{{ cihaz.cihaz_adi }} (v{{ cihaz.firmware_version }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Firmware Seçin</label>
                <select id="firmwareSelect" class="form-select">
                    <option value="">-- Versiyon Seçin --</option>
                    {% for firmware in versions %}
                    <option value="{{ firmware.version }}">v{{ firmware.version }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button id="assignFirmwareBtn" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Firmware Ata
        </button>
        <div id="assignResult" class="mt-3"></div>
    </div>
</div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#firmwareTable').DataTable({
        "order": [[1, "desc"]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/tr.json"
        }
    });

    // Function to update button state
    function updateButtonState() {
        const deviceSelected = $('#deviceSelect').val() !== '';
        const firmwareSelected = $('#firmwareSelect').val() !== '';
        $('#assignFirmwareBtn').prop('disabled', !(deviceSelected && firmwareSelected));
    }

    // Initial button state check
    updateButtonState();

    // Event listeners for select changes
    $('#deviceSelect, #firmwareSelect').on('change', updateButtonState);

    // Assign firmware button click handler
    $('#assignFirmwareBtn').click(function() {
        const deviceId = $('#deviceSelect').val();
        const firmwareVersion = $('#firmwareSelect').val();
        
        if (!deviceId || !firmwareVersion) {
            return;
        }
        
        $('#assignResult').html(`
            <div class="alert alert-info">
                <i class="fas fa-spinner fa-spin"></i> İşlem yapılıyor...
            </div>
        `);

        fetch('/assign_firmware', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_id: deviceId,
                version: firmwareVersion
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                $('#assignResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> ${data.error}
                    </div>
                `);
            } else {
                $('#assignResult').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> ${data.message}
                    </div>
                `);
            }
        })
        .catch(error => {
            $('#assignResult').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> İşlem sırasında hata oluştu
                </div>
            `);
            console.error('Error:', error);
        });
    });
});

function activateVersion(version) {
    if (confirm(`v${version} firmware'ini aktif etmek istediğinize emin misiniz?`)) {
        fetch('/firmware/activate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ version: version })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('İşlem başarısız oldu');
        });
    }
}
</script>
{% endblock %}
